<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiMitra - Marketplace</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-green: #2E7D32;
            --light-green: #4CAF50;
            --hover-green: #1B5E20;
            --bg-light: #F1F8E9;
            --text-dark: #2E3D2E;
            --border-light: #C8E6C9;
            --gold-accent: #FF8F00;
            --orange-accent: #FF6D00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #E8F5E8 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Header Styles */
        .header {
            background: white;
            box-shadow: 0 2px 20px rgba(46, 125, 50, 0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green) !important;
        }

        .nav-link {
            color: var(--text-dark) !important;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary-green) !important;
        }

        .btn-sell {
            background: linear-gradient(135deg, var(--gold-accent) 0%, var(--orange-accent) 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .btn-sell:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 143, 0, 0.4);
            color: white;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Filter Section */
        .filters {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(46, 125, 50, 0.1);
        }

        .filter-title {
            color: var(--primary-green);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .form-select, .form-control {
            border: 2px solid var(--border-light);
            border-radius: 10px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
        }

        .btn-filter {
            background: var(--primary-green);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            background: var(--hover-green);
            transform: translateY(-1px);
        }

        /* Product Cards */
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(46, 125, 50, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(46, 125, 50, 0.2);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-green);
            font-size: 3rem;
        }

        .product-content {
            padding: 1.5rem;
        }

        .product-category {
            background: var(--bg-light);
            color: var(--primary-green);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 0.75rem;
        }

        .product-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .product-farmer {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 1rem;
        }

        .product-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-contact {
            flex: 1;
            background: var(--primary-green);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-contact:hover {
            background: var(--hover-green);
            color: white;
        }

        .btn-favorite {
            background: transparent;
            border: 2px solid var(--border-light);
            color: var(--primary-green);
            padding: 0.75rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .btn-favorite:hover {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }

        .btn-favorite.active {
            background: var(--gold-accent);
            border-color: var(--gold-accent);
            color: white;
        }

        /* Floating Add Button */
        .floating-add-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--gold-accent) 0%, var(--orange-accent) 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(255, 143, 0, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 143, 0, 0.6);
            color: white;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 60px rgba(46, 125, 50, 0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            border-bottom: none;
        }

        .modal-title {
            font-weight: 700;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        .form-label {
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.3);
            color: white;
        }

        /* Loading States */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--border-light);
            margin-bottom: 1rem;
        }

        /* Success Animation */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .filters {
                padding: 1rem;
            }
            
            .floating-add-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg">
                <a class="navbar-brand" href="dashboard.html"><i class="bi bi-flower1"></i> KrishiMitra</a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="market.html"><i class="bi bi-shop"></i> Marketplace</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#my-products"><i class="bi bi-box-seam"></i> My Products</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#profile"><i class="bi bi-person"></i> Profile</a>
                        </li>
                        <li class="nav-item ms-2">
                            <button class="btn btn-sell" data-bs-toggle="modal" data-bs-target="#sellModal">
                                <i class="bi bi-plus-circle"></i> Sell Products
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container text-center">
            <h1><i class="bi bi-basket"></i> KrishiMitra Marketplace</h1>
            <p>Connect with farmers, buy fresh crops and quality seeds directly from the source</p>
        </div>
    </section>

    <div class="container">
        <!-- Filters -->
        <div class="filters">
            <h5 class="filter-title"><i class="bi bi-funnel"></i> Filter Products</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="crops">Crops</option>
                        <option value="seeds">Seeds</option>
                        <option value="fruits">Fruits</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="grains">Grains</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="priceFilter">
                        <option value="">Price Range</option>
                        <option value="0-100">‚Çπ0 - ‚Çπ100</option>
                        <option value="100-500">‚Çπ100 - ‚Çπ500</option>
                        <option value="500-1000">‚Çπ500 - ‚Çπ1000</option>
                        <option value="1000+">‚Çπ1000+</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="locationFilter" placeholder="Enter location">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchFilter" placeholder="Search products...">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <button class="btn btn-filter" onclick="applyFilters()">
                        <i class="bi bi-search"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsContainer">
            <div class="row" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5" style="display: none;">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-2">Loading products...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="bi bi-basket"></i>
            <h3>No products found</h3>
            <p>Try adjusting your filters or search terms</p>
        </div>
    </div>

    <!-- Floating Add Button -->
    <button class="floating-add-btn" data-bs-toggle="modal" data-bs-target="#sellModal" title="Sell Your Products">
        <i class="bi bi-plus"></i>
    </button>

    <!-- Sell Product Modal -->
    <div class="modal fade" id="sellModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> List Your Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sellForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="productCategory" class="form-label">Category</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="crops">Crops</option>
                                    <option value="seeds">Seeds</option>
                                    <option value="fruits">Fruits</option>
                                    <option value="vegetables">Vegetables</option>
                                    <option value="grains">Grains</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productPrice" class="form-label">Price per kg/unit (‚Çπ)</label>
                                <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label for="productQuantity" class="form-label">Available Quantity</label>
                                <input type="number" class="form-control" id="productQuantity" min="1" required>
                            </div>
                            <div class="col-md-6">
                                <label for="productUnit" class="form-label">Unit</label>
                                <select class="form-select" id="productUnit" required>
                                    <option value="">Select Unit</option>
                                    <option value="kg">Kilogram (kg)</option>
                                    <option value="quintal">Quintal</option>
                                    <option value="ton">Ton</option>
                                    <option value="pieces">Pieces</option>
                                    <option value="bags">Bags</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="productLocation" required>
                            </div>
                            <div class="col-12">
                                <label for="productDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="productDescription" rows="3" placeholder="Describe your product quality, harvest date, etc."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="contactPhone" class="form-label">Contact Phone</label>
                                <input type="tel" class="form-control" id="contactPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label for="contactEmail" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="contactEmail">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-submit" onclick="submitProduct()" id="submitButton">
                        <span id="submitText">
                            <i class="bi bi-check-circle"></i> List Product
                        </span>
                        <span id="submitLoader" style="display: none;">
                            <div class="loading-spinner me-2"></div> Processing...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-telephone"></i> Contact Farmer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="contactInfo">
                    <!-- Contact information will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = "https://nqicnorwwztqdwjyodae.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xaWNub3J3d3p0cWR3anlvZGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NzY4NDcsImV4cCI6MjA3NDM1Mjg0N30.qrbvcx0FRful2Lv3RcrevVmGGXKLJRDHU6-TX-uidKw";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Sample product data + user products from localStorage
        let defaultProducts = [
            {
                id: 1,
                name: "Fresh Tomatoes",
                category: "vegetables",
                price: 45,
                quantity: 500,
                unit: "kg",
                farmer: "Rajesh Kumar",
                location: "Punjab",
                description: "Fresh, organic tomatoes harvested yesterday. Perfect for cooking and salads.",
                phone: "+91 98765 43210",
                email: "rajesh.kumar@gmail.com",
                icon: "üçÖ",
                isUserProduct: false
            },
            {
                id: 2,
                name: "Wheat Seeds (High Yield)",
                category: "seeds",
                price: 2500,
                quantity: 50,
                unit: "quintal",
                farmer: "Priya Sharma",
                location: "Haryana",
                description: "Premium quality wheat seeds with 95% germination rate. Disease resistant variety.",
                phone: "+91 98765 43211",
                email: "priya.sharma@gmail.com",
                icon: "üåæ",
                isUserProduct: false
            },
            {
                id: 3,
                name: "Basmati Rice",
                category: "grains",
                price: 120,
                quantity: 200,
                unit: "kg",
                farmer: "Amit Singh",
                location: "Uttar Pradesh",
                description: "Aromatic basmati rice, aged for 2 years. Premium quality for export.",
                phone: "+91 98765 43212",
                email: "amit.singh@gmail.com",
                icon: "üçö",
                isUserProduct: false
            },
            {
                id: 4,
                name: "Fresh Mangoes (Alphonso)",
                category: "fruits",
                price: 300,
                quantity: 100,
                unit: "kg",
                farmer: "Sunita Patel",
                location: "Maharashtra",
                description: "King of mangoes - Alphonso variety. Sweet, juicy and perfectly ripe.",
                phone: "+91 98765 43213",
                email: "sunita.patel@gmail.com",
                icon: "ü•≠",
                isUserProduct: false
            },
            {
                id: 5,
                name: "Onion Bulbs",
                category: "vegetables",
                price: 35,
                quantity: 1000,
                unit: "kg",
                farmer: "Mohan Reddy",
                location: "Karnataka",
                description: "Fresh red onions with long shelf life. Ideal for storage and distribution.",
                phone: "+91 98765 43214",
                email: "mohan.reddy@gmail.com",
                icon: "üßÖ",
                isUserProduct: false
            },
            {
                id: 6,
                name: "Cotton Seeds (Bt)",
                category: "seeds",
                price: 800,
                quantity: 25,
                unit: "bags",
                farmer: "Lakshmi Devi",
                location: "Telangana",
                description: "Genetically modified cotton seeds with pest resistance. High yield variety.",
                phone: "+91 98765 43215",
                email: "lakshmi.devi@gmail.com",
                icon: "üå±",
                isUserProduct: false
            }
        ];

        let products = [...defaultProducts];
        let filteredProducts = [...products];
        let favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));

        // Load user products from localStorage and merge with default products
        function loadAllProducts() {
            const userProducts = JSON.parse(localStorage.getItem('userProducts') || '[]');
            const userProductsWithFlag = userProducts.map(product => ({
                ...product,
                isUserProduct: true,
                farmer: "You"
            }));
            
            products = [...userProductsWithFlag, ...defaultProducts];
            filteredProducts = [...products];
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadAllProducts();
            displayProducts(products);
            checkEditMode();
        });

        // Check if editing a product
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                const editProduct = JSON.parse(localStorage.getItem('editProduct') || 'null');
                if (editProduct) {
                    populateEditForm(editProduct);
                    const modal = new bootstrap.Modal(document.getElementById('sellModal'));
                    modal.show();
                    
                    // Clear edit data
                    localStorage.removeItem('editProduct');
                    history.replaceState(null, null, 'market.html');
                }
            }
        }

        // Populate form for editing
        function populateEditForm(product) {
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productUnit').value = product.unit;
            document.getElementById('productLocation').value = product.location;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('contactPhone').value = product.phone;
            document.getElementById('contactEmail').value = product.email;
            
            // Change modal title and button text for editing
            document.querySelector('.modal-title').innerHTML = '<i class="bi bi-pencil-square"></i> Edit Your Product';
            document.getElementById('submitText').innerHTML = '<i class="bi bi-check-circle"></i> Update Product';
            
            // Store edit mode
            window.editingProductId = product.id;
        }

        // Display products
        function displayProducts(productsToShow) {
            const container = document.getElementById('productsGrid');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');

            if (productsToShow.length === 0) {
                container.style.display = 'none';
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';

            container.innerHTML = productsToShow.map(product => `
                <div class="col-lg-4 col-md-6">
                    <div class="product-card ${product.isUserProduct ? 'border border-warning' : ''}">
                        ${product.isUserProduct ? '<div class="position-absolute top-0 end-0 m-2"><span class="badge bg-warning text-dark">Your Product</span></div>' : ''}
                        <div class="product-image">
                            <span style="font-size: 4rem;">${product.icon}</span>
                        </div>
                        <div class="product-content">
                            <span class="product-category">${product.category.toUpperCase()}</span>
                            <h3 class="product-title">${product.name}</h3>
                            <p class="product-farmer">
                                <i class="bi bi-person-circle"></i> ${product.farmer} ‚Ä¢ <i class="bi bi-geo-alt"></i> ${product.location}
                            </p>
                            <div class="product-price">‚Çπ${product.price}/${product.unit}</div>
                            <div class="product-details">
                                <span><i class="bi bi-box"></i> ${product.quantity} ${product.unit} available</span>
                            </div>
                            <div class="product-actions">
                                ${product.isUserProduct ? 
                                    `<button class="btn btn-contact" onclick="editUserProduct(${product.id})">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-favorite" onclick="deleteUserProduct(${product.id})" style="background: #dc3545; border-color: #dc3545;">
                                        <i class="bi bi-trash"></i>
                                    </button>` :
                                    `<button class="btn btn-contact" onclick="contactFarmer(${product.id})">
                                        <i class="bi bi-telephone"></i> Contact
                                    </button>
                                    <button class="btn btn-favorite ${favorites.has(product.id) ? 'active' : ''}" onclick="toggleFavorite(${product.id})">
                                        <i class="bi bi-heart${favorites.has(product.id) ? '-fill' : ''}"></i>
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Edit user product
        function editUserProduct(productId) {
            const product = products.find(p => p.id === productId && p.isUserProduct);
            if (product) {
                populateEditForm(product);
                const modal = new bootstrap.Modal(document.getElementById('sellModal'));
                modal.show();
            }
        }

        // Delete user product
        function deleteUserProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                // Remove from user products in localStorage
                let userProducts = JSON.parse(localStorage.getItem('userProducts') || '[]');
                userProducts = userProducts.filter(p => p.id !== productId);
                localStorage.setItem('userProducts', JSON.stringify(userProducts));
                
                // Reload all products
                loadAllProducts();
                displayProducts(filteredProducts);
                
                showAlert('Product deleted successfully!', 'success');
            }
        }

        // Filter functions
        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const priceRange = document.getElementById('priceFilter').value;
            const location = document.getElementById('locationFilter').value.toLowerCase();
            const search = document.getElementById('searchFilter').value.toLowerCase();

            filteredProducts = products.filter(product => {
                // Category filter
                if (category && product.category !== category) return false;

                // Price filter
                if (priceRange) {
                    const [min, max] = priceRange.split('-').map(p => p.replace('+', ''));
                    const price = product.price;
                    if (max) {
                        if (price < parseInt(min) || price > parseInt(max)) return false;
                    } else {
                        if (price < parseInt(min)) return false;
                    }
                }

                // Location filter
                if (location && !product.location.toLowerCase().includes(location)) return false;

                // Search filter
                if (search && !product.name.toLowerCase().includes(search) && 
                    !product.farmer.toLowerCase().includes(search)) return false;

                return true;
            });

            displayProducts(filteredProducts);
        }

        function clearFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('priceFilter').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('searchFilter').value = '';
            filteredProducts = [...products];
            displayProducts(products);
        }

        // Favorites
        function toggleFavorite(productId) {
            if (favorites.has(productId)) {
                favorites.delete(productId);
            } else {
                favorites.add(productId);
            }
            
            // Save to localStorage
            localStorage.setItem('favorites', JSON.stringify([...favorites]));
            displayProducts(filteredProducts);
        }

        // Contact farmer
        function contactFarmer(productId) {
            const product = products.find(p => p.id === productId);
            const contactInfo = document.getElementById('contactInfo');
            
            contactInfo.innerHTML = `
                <div class="mb-3">
                    <h6><i class="bi bi-person-circle"></i> ${product.farmer}</h6>
                    <p class="mb-2"><strong>Product:</strong> ${product.name}</p>
                    <p class="mb-2"><strong>Location:</strong> ${product.location}</p>
                    <p class="mb-3">${product.description}</p>
                </div>
                <div class="contact-methods">
                    <div class="mb-2">
                        <strong><i class="bi bi-telephone"></i> Phone:</strong>
                        <a href="tel:${product.phone}" class="ms-2 text-decoration-none">${product.phone}</a>
                    </div>
                    ${product.email ? `
                    <div class="mb-2">
                        <strong><i class="bi bi-envelope"></i> Email:</strong>
                        <a href="mailto:${product.email}" class="ms-2 text-decoration-none">${product.email}</a>
                    </div>
                    ` : ''}
                </div>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> 
                    Contact the farmer directly to discuss pricing, delivery, and payment terms.
                </div>
            `;
            
            const contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
            contactModal.show();
        }

        // Enhanced Submit Product Function
        async function submitProduct() {
            const form = document.getElementById('sellForm');
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');

            // Show loading state
            submitText.style.display = 'none';
            submitLoader.style.display = 'inline-flex';
            submitButton.disabled = true;

            try {
                // Basic validation
                const requiredFields = ['productName', 'productCategory', 'productPrice', 'productQuantity', 'productUnit', 'productLocation', 'contactPhone'];
                let isValid = true;

                requiredFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (!element.value.trim()) {
                        element.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        element.classList.remove('is-invalid');
                    }
                });

                if (!isValid) {
                    throw new Error('Please fill in all required fields.');
                }

                // Advanced validation
                const phone = document.getElementById('contactPhone').value;
                const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
                if (!phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''))) {
                    document.getElementById('contactPhone').classList.add('is-invalid');
                    throw new Error('Please enter a valid phone number.');
                }

                const email = document.getElementById('contactEmail').value;
                if (email) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        document.getElementById('contactEmail').classList.add('is-invalid');
                        throw new Error('Please enter a valid email address.');
                    }
                }

                // Get current user
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    throw new Error('You must be logged in to list products.');
                }

                // Create product object
                const productData = {
                    id: window.editingProductId || Date.now(),
                    name: document.getElementById('productName').value.trim(),
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    quantity: parseInt(document.getElementById('productQuantity').value),
                    unit: document.getElementById('productUnit').value,
                    location: document.getElementById('productLocation').value.trim(),
                    description: document.getElementById('productDescription').value.trim() || "No description provided",
                    phone: document.getElementById('contactPhone').value.trim(),
                    email: document.getElementById('contactEmail').value.trim(),
                    farmer: "You",
                    icon: getCategoryIcon(document.getElementById('productCategory').value),
                    isUserProduct: true,
                    userId: user.id,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };

                // Save to Supabase
                let dbOperation;
                if (window.editingProductId) {
                    dbOperation = supabase
                        .from('products')
                        .upsert(productData);
                } else {
                    dbOperation = supabase
                        .from('products')
                        .insert([productData]);
                }

                const { error: dbError } = await dbOperation;
                if (dbError) {
                    console.warn('Database save failed, using localStorage fallback:', dbError);
                }

                // Save to localStorage as backup/primary storage
                let userProducts = JSON.parse(localStorage.getItem('userProducts') || '[]');
                
                if (window.editingProductId) {
                    // Update existing product
                    const index = userProducts.findIndex(p => p.id === window.editingProductId);
                    if (index !== -1) {
                        userProducts[index] = productData;
                    } else {
                        userProducts.unshift(productData);
                    }
                } else {
                    // Add new product
                    userProducts.unshift(productData);
                }

                localStorage.setItem('userProducts', JSON.stringify(userProducts));

                // Show success animation
                showSuccessAnimation();

                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('sellModal'));
                setTimeout(() => {
                    modal.hide();
                    form.reset();
                    
                    // Reset modal for next use
                    document.querySelector('.modal-title').innerHTML = '<i class="bi bi-plus-circle"></i> List Your Product';
                    document.getElementById('submitText').innerHTML = '<i class="bi bi-check-circle"></i> List Product';
                    delete window.editingProductId;
                    
                }, 1500);

                // Refresh products display
                loadAllProducts();
                displayProducts(filteredProducts);

                // Show success message with options
                setTimeout(() => {
                    const action = confirm('Product ' + (window.editingProductId ? 'updated' : 'listed') + ' successfully! Would you like to view your dashboard to manage all your products?');
                    if (action) {
                        window.location.href = 'dashboard.html';
                    }
                }, 2000);

            } catch (error) {
                showAlert(error.message, 'danger');
                console.error('Product submission error:', error);
            } finally {
                // Reset button state
                submitText.style.display = 'inline-flex';
                submitLoader.style.display = 'none';
                submitButton.disabled = false;
            }
        }

        // Show success animation
        function showSuccessAnimation() {
            const animation = document.createElement('div');
            animation.className = 'success-animation';
            animation.innerHTML = `
                <div style="color: var(--primary-green); font-size: 3rem; margin-bottom: 1rem;">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h4 style="color: var(--primary-green); margin-bottom: 0.5rem;">Success!</h4>
                <p style="color: #666; margin: 0;">Product ${window.editingProductId ? 'updated' : 'listed'} successfully</p>
            `;
            
            document.body.appendChild(animation);
            
            setTimeout(() => {
                animation.remove();
            }, 1500);
        }

        function getCategoryIcon(category) {
            const icons = {
                'crops': 'üåæ',
                'seeds': 'üå±',
                'fruits': 'üçé',
                'vegetables': 'ü•ï',
                'grains': 'üåæ'
            };
            return icons[category] || 'üå±';
        }

        // Enhanced Alert system
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlert = document.querySelector('.alert-notification');
            if (existingAlert) {
                existingAlert.remove();
            }

            // Create new alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-notification position-fixed`;
            alert.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 350px;
                max-width: 500px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                border-radius: 10px;
                border: none;
                animation: slideInRight 0.3s ease-out;
            `;
            
            const iconMap = {
                'success': 'check-circle-fill',
                'danger': 'exclamation-triangle-fill',
                'warning': 'exclamation-triangle-fill',
                'info': 'info-circle-fill'
            };
            
            alert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${iconMap[type] || 'info-circle-fill'} me-2"></i>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;

            // Add CSS animation
            if (!document.querySelector('#alertAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'alertAnimationStyle';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(alert);

            // Auto remove after 6 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => alert.remove(), 300);
                }
            }, 6000);
        }

        // Search functionality
        document.getElementById('searchFilter').addEventListener('input', function(e) {
            if (e.target.value === '') {
                applyFilters();
            }
        });

        document.getElementById('searchFilter').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // Auto-apply filters
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('priceFilter').addEventListener('change', applyFilters);
        document.getElementById('locationFilter').addEventListener('input', function(e) {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(applyFilters, 500);
        });

        // Enhanced form validation
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('sellForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateField(this);
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid')) {
                        validateField(this);
                    }
                });
            });
        });

        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;

            if (field.hasAttribute('required') && !value) {
                isValid = false;
            } else if (field.type === 'tel' && value) {
                const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
                if (!phoneRegex.test(value.replace(/[\s\-\(\)]/g, ''))) {
                    isValid = false;
                }
            } else if (field.type === 'email' && value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    isValid = false;
                }
            } else if (field.type === 'number' && value) {
                const num = parseFloat(value);
                if (isNaN(num) || num <= 0) {
                    isValid = false;
                }
            }

            field.classList.toggle('is-invalid', !isValid);
            field.classList.toggle('is-valid', isValid && value);

            return isValid;
        }

        // Loading simulation for better UX
        function showLoadingState() {
            document.getElementById('productsGrid').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
        }

        // Enhanced search with debouncing
        let searchTimeout;
        document.getElementById('searchFilter').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            if (e.target.value.length > 2) {
                showLoadingState();
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 400);
            } else if (e.target.value.length === 0) {
                applyFilters();
            }
        });

        // Modal reset on close
        document.getElementById('sellModal').addEventListener('hidden.bs.modal', function () {
            const form = document.getElementById('sellForm');
            form.reset();
            form.querySelectorAll('.is-invalid, .is-valid').forEach(el => {
                el.classList.remove('is-invalid', 'is-valid');
            });
            
            // Reset modal for next use if not editing
            if (!window.editingProductId) {
                document.querySelector('.modal-title').innerHTML = '<i class="bi bi-plus-circle"></i> List Your Product';
                document.getElementById('submitText').innerHTML = '<i class="bi bi-check-circle"></i> List Product';
            }
        });

        // Listen for storage changes (from dashboard)
        window.addEventListener('storage', function(e) {
            if (e.key === 'userProducts') {
                loadAllProducts();
                displayProducts(filteredProducts);
            }
        });

        // Auto-save form data
        function autoSaveForm() {
            const form = document.getElementById('sellForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            if (Object.values(data).some(v => v.trim())) {
                localStorage.setItem('draftProduct', JSON.stringify(data));
            }
        }

        // Load draft on modal open
        document.getElementById('sellModal').addEventListener('shown.bs.modal', function () {
            if (!window.editingProductId) {
                const draft = localStorage.getItem('draftProduct');
                if (draft) {
                    const data = JSON.parse(draft);
                    Object.entries(data).forEach(([key, value]) => {
                        const field = document.getElementById(key);
                        if (field && value) {
                            field.value = value;
                        }
                    });
                }
            }
        });

        // Clear draft on successful submission
        function clearDraft() {
            localStorage.removeItem('draftProduct');
        }

        // Add auto-save to form inputs
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('sellForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    clearTimeout(this.autoSaveTimeout);
                    this.autoSaveTimeout = setTimeout(autoSaveForm, 1000);
                });
            });
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Note: Service Worker functionality would be implemented in production
        // for offline capabilities and caching

    </script>
</body>
</html>