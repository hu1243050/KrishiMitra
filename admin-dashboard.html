<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiMitra - Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        :root{--primary-green:#2E7D32;--light-green:#4CAF50;--hover-green:#1B5E20;--bg-light:#F1F8E9;--text-dark:#2E3D2E;--border-light:#C8E6C9;--gold-accent:#FF8F00;--orange-accent:#FF6D00;--admin-blue:#1976D2;--admin-purple:#7B1FA2}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;overflow-x:hidden}.sidebar{position:fixed;top:0;left:0;height:100vh;width:280px;background:linear-gradient(180deg,#1a237e 0%,#0d47a1 50%,#01579b 100%);color:white;overflow-y:auto;z-index:1000;transition:transform .4s cubic-bezier(.4,0,.2,1);box-shadow:4px 0 20px rgba(0,0,0,.3)}.sidebar::-webkit-scrollbar{width:6px}.sidebar::-webkit-scrollbar-track{background:rgba(255,255,255,.1)}.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.3);border-radius:10px}.sidebar-header{padding:2rem 1.5rem;text-align:center;border-bottom:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.2)}.sidebar-header i{font-size:3rem;color:var(--gold-accent);animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.8}}.sidebar-header h3{font-size:1.75rem;font-weight:700;margin:1rem 0 .25rem 0;background:linear-gradient(135deg,#fff,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.sidebar-menu{list-style:none;padding:1.5rem 0;margin:0}.sidebar-menu li{margin:.5rem 0;opacity:0;animation:slideInLeft .5s ease forwards}.sidebar-menu li:nth-child(1){animation-delay:.1s}.sidebar-menu li:nth-child(2){animation-delay:.2s}.sidebar-menu li:nth-child(3){animation-delay:.3s}.sidebar-menu li:nth-child(4){animation-delay:.4s}.sidebar-menu li:nth-child(5){animation-delay:.5s}.sidebar-menu li:nth-child(6){animation-delay:.6s}.sidebar-menu li:nth-child(7){animation-delay:.7s}@keyframes slideInLeft{from{transform:translateX(-30px);opacity:0}to{transform:translateX(0);opacity:1}}.sidebar-menu a{display:flex;align-items:center;padding:1rem 1.5rem;color:rgba(255,255,255,.8);text-decoration:none;transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}.sidebar-menu a::before{content:'';position:absolute;left:0;top:0;height:100%;width:4px;background:var(--gold-accent);transform:scaleY(0);transition:transform .3s ease}.sidebar-menu a:hover,.sidebar-menu a.active{background:rgba(255,255,255,.15);color:white;transform:translateX(5px)}.sidebar-menu a:hover::before,.sidebar-menu a.active::before{transform:scaleY(1)}.sidebar-menu i{margin-right:1rem;font-size:1.3rem;transition:transform .3s ease}.sidebar-menu a:hover i{transform:scale(1.2) rotate(5deg)}.main-content{margin-left:280px;padding:2rem;min-height:100vh;transition:margin-left .4s cubic-bezier(.4,0,.2,1)}.top-bar{background:white;padding:1.5rem 2rem;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1);margin-bottom:2rem;display:flex;justify-content:space-between;align-items:center;animation:slideDown .6s ease}@keyframes slideDown{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}.stat-card{background:white;border-radius:20px;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:all .4s cubic-bezier(.4,0,.2,1);height:100%;position:relative;overflow:hidden;animation:fadeInUp .6s ease forwards;opacity:0}.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2);transform:scaleX(0);transition:transform .4s ease}.stat-card:hover::before{transform:scaleX(1)}.stat-card:nth-child(1){animation-delay:.1s}.stat-card:nth-child(2){animation-delay:.2s}.stat-card:nth-child(3){animation-delay:.3s}.stat-card:nth-child(4){animation-delay:.4s}@keyframes fadeInUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}.stat-card:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 20px 50px rgba(0,0,0,.15)}.stat-icon{width:70px;height:70px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:1rem;animation:rotateIn .6s ease}@keyframes rotateIn{from{transform:rotate(-180deg) scale(0);opacity:0}to{transform:rotate(0) scale(1);opacity:1}}.stat-value{font-size:2.5rem;font-weight:700;margin-bottom:.5rem;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.dashboard-card{background:white;border-radius:20px;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,.1);margin-bottom:2rem;animation:fadeIn .6s ease;transition:all .3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.dashboard-card:hover{box-shadow:0 15px 40px rgba(0,0,0,.15)}.table{animation:fadeIn .8s ease}.table tbody tr{transition:all .3s ease}.table tbody tr:hover{background:#f8f9fa;transform:scale(1.01);box-shadow:0 4px 10px rgba(0,0,0,.05)}.btn-action{padding:.5rem .875rem;border-radius:10px;border:none;font-size:.875rem;margin:0 .25rem;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1)}.btn-action:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,.2)}.btn-view{background:linear-gradient(135deg,#667eea,#764ba2);color:white}.btn-edit{background:linear-gradient(135deg,#11998e,#38ef7d);color:white}.btn-delete{background:linear-gradient(135deg,#eb3349,#f45c43);color:white}.notification-dropdown{position:relative}.notification-bell{background:linear-gradient(135deg,var(--gold-accent),var(--orange-accent));color:white;border:none;border-radius:15px;padding:.75rem 1.25rem;cursor:pointer;transition:all .3s ease;position:relative}.notification-bell:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(255,143,0,.4)}.notification-menu{position:absolute;top:60px;right:0;width:350px;max-height:450px;background:white;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow-y:auto;z-index:1000;transform:translateY(-20px);opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.4,0,.2,1)}.notification-menu.show{transform:translateY(0);opacity:1;pointer-events:all}.notification-item{padding:1rem 1.5rem;border-bottom:1px solid #f0f0f0;transition:background .3s ease;cursor:pointer}.notification-item:hover{background:#f8f9fa}.notification-item.unread{background:#e3f2fd}.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.modal-content{border-radius:20px;border:none;animation:modalSlideIn .4s ease}@keyframes modalSlideIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}.error-message{background:#ffe6e6;border-left:4px solid #ff4444;padding:1rem;border-radius:10px;margin:1rem 0}@keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}@media (max-width:768px){.sidebar{transform:translateX(-280px)}.sidebar.mobile-open{transform:translateX(0)}.main-content{margin-left:0}}.mobile-menu-btn{display:none;position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;font-size:1.5rem;box-shadow:0 8px 20px rgba(0,0,0,.3);z-index:999;animation:bounce 2s infinite}@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}@media (max-width:768px){.mobile-menu-btn{display:block}}
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-shield-check"></i>
            <h3>KrishiMitra</h3>
            <small>Admin Panel</small>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#overview" class="active" onclick="showSection('overview')"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="#users" onclick="showSection('users')"><i class="bi bi-people"></i> Users Management</a></li>
            <li><a href="#products" onclick="showSection('products')"><i class="bi bi-box-seam"></i> Products</a></li>
            <li><a href="#queries" onclick="showSection('queries')"><i class="bi bi-chat-left-text"></i> Expert Queries</a></li>
            <li><a href="#analytics" onclick="showSection('analytics')"><i class="bi bi-graph-up"></i> Analytics</a></li>
            <li><a href="#settings" onclick="showSection('settings')"><i class="bi bi-gear"></i> Settings</a></li>
            <li><a href="#" onclick="logout()" style="color:#ff6b6b"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
    </aside>
    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
    <main class="main-content">
        <div class="top-bar">
            <div>
                <h2 style="margin:0;font-weight:700">Admin Dashboard</h2>
                <small style="color:#666" id="currentDateTime"></small>
            </div>
            <div style="display:flex;align-items:center;gap:1rem">
                <div class="notification-dropdown">
                    <button class="notification-bell" onclick="toggleNotifications()">
                        <i class="bi bi-bell"></i> 
                        <span class="badge bg-danger" id="notificationCount">0</span>
                    </button>
                    <div class="notification-menu" id="notificationMenu">
                        <div style="padding:1rem 1.5rem;border-bottom:2px solid #f0f0f0;font-weight:600">Notifications</div>
                        <div id="notificationList"></div>
                    </div>
                </div>
                <div class="user-avatar" style="width:45px;height:45px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;cursor:pointer" id="userAvatar">A</div>
            </div>
        </div>
        <section id="overview" class="section-content">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#667eea,#764ba2)"><i class="bi bi-people text-white"></i></div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#f093fb,#f5576c)"><i class="bi bi-box-seam text-white"></i></div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#4facfe,#00f2fe)"><i class="bi bi-chat-left-text text-white"></i></div>
                        <div class="stat-value" id="totalQueries">0</div>
                        <div class="stat-label">Expert Queries</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:linear-gradient(135deg,#43e97b,#38f9d7)"><i class="bi bi-graph-up text-white"></i></div>
                        <div class="stat-value">₹<span id="totalRevenue">0</span></div>
                        <div class="stat-label">Revenue (Est.)</div>
                    </div>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="dashboard-card">
                        <h4><i class="bi bi-graph-up"></i> User Growth</h4>
                        <div style="position:relative;height:300px;margin-top:1rem"><canvas id="userGrowthChart"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="dashboard-card">
                        <h4><i class="bi bi-clock-history"></i> Recent Activity</h4>
                        <div id="recentActivity" style="margin-top:1rem"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="users" class="section-content" style="display:none">
            <div class="dashboard-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
                    <h4><i class="bi bi-people"></i> Users Management</h4>
                </div>
                <div style="display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap">
                    <input type="text" class="form-control" placeholder="Search users..." id="userSearch" style="flex:1;min-width:250px;border-radius:10px">
                    <button class="btn btn-secondary" onclick="loadUsers()" style="border-radius:10px"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>
                <div style="overflow-x:auto">
                    <table class="table table-hover">
                        <thead><tr><th>User</th><th>Email</th><th>Phone</th><th>Role</th><th>Joined</th><th>Actions</th></tr></thead>
                        <tbody id="usersTableBody"><tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading users...</p></td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>
        <section id="products" class="section-content" style="display:none">
            <div class="dashboard-card">
                <h4><i class="bi bi-box-seam"></i> Products Management</h4>
                <div style="display:flex;gap:1rem;margin:1.5rem 0;flex-wrap:wrap">
                    <input type="text" class="form-control" placeholder="Search products..." id="productSearch" style="flex:1;min-width:250px;border-radius:10px">
                    <select class="form-select" id="categoryFilter" style="min-width:150px;border-radius:10px">
                        <option value="">All Categories</option>
                        <option value="grains">Grains</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                        <option value="dairy">Dairy</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadProducts()" style="border-radius:10px"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>
                <div style="overflow-x:auto">
                    <table class="table table-hover">
                        <thead><tr><th>Product</th><th>Category</th><th>Seller</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead>
                        <tbody id="productsTableBody"><tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading products...</p></td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>
        <section id="queries" class="section-content" style="display:none">
            <div class="dashboard-card">
                <h4><i class="bi bi-chat-left-text"></i> Expert Queries</h4>
                <div style="display:flex;gap:1rem;margin:1.5rem 0;flex-wrap:wrap">
                    <input type="text" class="form-control" placeholder="Search queries..." id="querySearch" style="flex:1;min-width:250px;border-radius:10px">
                    <select class="form-select" id="queryStatusFilter" style="min-width:150px;border-radius:10px">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="resolved">Resolved</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadQueries()" style="border-radius:10px"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>
                <div style="overflow-x:auto">
                    <table class="table table-hover">
                        <thead><tr><th>Date</th><th>Farmer</th><th>Phone</th><th>Query</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="queriesTableBody"><tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading queries...</p></td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>
        <section id="analytics" class="section-content" style="display:none">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="dashboard-card">
                        <h4><i class="bi bi-pie-chart"></i> Product Categories</h4>
                        <div style="position:relative;height:300px;margin-top:1rem"><canvas id="categoryChart"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="dashboard-card">
                        <h4><i class="bi bi-bar-chart"></i> Monthly Revenue</h4>
                        <div style="position:relative;height:300px;margin-top:1rem"><canvas id="revenueChart"></canvas></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="settings" class="section-content" style="display:none">
            <div class="dashboard-card">
                <h4><i class="bi bi-gear"></i> System Settings</h4>
                <div class="row g-4" style="margin-top:1rem">
                    <div class="col-md-6">
                        <h5>General Settings</h5>
                        <div class="mb-3"><label class="form-label">Platform Name</label><input type="text" class="form-control" value="KrishiMitra" style="border-radius:10px"></div>
                        <div class="mb-3"><label class="form-label">Admin Email</label><input type="email" class="form-control" value="admin@krishimitra.com" style="border-radius:10px"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Feature Toggles</h5>
                        <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="enableMarketplace" checked><label class="form-check-label" for="enableMarketplace">Enable Marketplace</label></div>
                        <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" id="enableAI" checked><label class="form-check-label" for="enableAI">Enable AI Assistant</label></div>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" style="background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:10px"><i class="bi bi-save"></i> Save Settings</button>
            </div>
        </section>
    </main>
    <div class="modal fade" id="queryDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white">
                    <h5 class="modal-title"><i class="bi bi-chat-dots"></i> Query Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="queryDetailBody"><div class="text-center py-4"><div class="loading-spinner mx-auto"></div></div></div>
            </div>
        </div>
    </div>
    <script>
const supabaseUrl = "https://nqicnorwwztqdwjyodae.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xaWNub3J3d3p0cWR3anlvZGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NzY4NDcsImV4cCI6MjA3NDM1Mjg0N30.qrbvcx0FRful2Lv3RcrevVmGGXKLJRDHU6-TX-uidKw";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let userGrowthChart, categoryChart, revenueChart;
let notifications = [];

function showSection(sectionId) {
    document.querySelectorAll('.section-content').forEach(s => s.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';
    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
    event.target.closest('a').classList.add('active');
    if (sectionId === 'users') loadUsers();
    if (sectionId === 'products') loadProducts();
    if (sectionId === 'queries') loadQueries();
    if (sectionId === 'analytics') setTimeout(initCharts, 100);
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('mobile-open');
}

function toggleNotifications() {
    document.getElementById('notificationMenu').classList.toggle('show');
}

document.addEventListener('click', function(e) {
    const menu = document.getElementById('notificationMenu');
    const bell = document.querySelector('.notification-bell');
    if (!menu.contains(e.target) && !bell.contains(e.target)) {
        menu.classList.remove('show');
    }
});

async function loadNotifications() {
    try {
        const { data: queries, error } = await supabase.from('expert_queries').select('*').order('created_at', { ascending: false }).limit(10);
        if (error) console.error('Error loading notifications:', error);
        const { data: products } = await supabase.from('marketplace_products').select('*').order('created_at', { ascending: false }).limit(5);
        notifications = [];
        if (queries && queries.length > 0) {
            queries.forEach(q => {
                notifications.push({
                    type: 'query',
                    icon: 'chat-left-text',
                    text: `New query from ${q.name || 'Farmer'}`,
                    time: getTimeAgo(q.created_at),
                    unread: true,
                    data: q
                });
            });
        }
        if (products && products.length > 0) {
            products.forEach(p => {
                notifications.push({
                    type: 'product',
                    icon: 'box-seam',
                    text: `New product: ${p.name}`,
                    time: getTimeAgo(p.created_at),
                    unread: false,
                    data: p
                });
            });
        }
        notifications.sort((a, b) => new Date(b.data.created_at) - new Date(a.data.created_at));
        document.getElementById('notificationCount').textContent = notifications.filter(n => n.unread).length;
        renderNotifications();
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function renderNotifications() {
    const listEl = document.getElementById('notificationList');
    if (notifications.length === 0) {
        listEl.innerHTML = '<div class="notification-item text-center">No notifications</div>';
        return;
    }
    listEl.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="handleNotificationClick('${n.type}', '${n.data.id}')">
            <div style="display: flex; gap: 1rem; align-items: start;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="bi bi-${n.icon}"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${n.text}</div>
                    <small style="color: #666;">${n.time}</small>
                </div>
                ${n.unread ? '<div style="width: 8px; height: 8px; background: #f45c43; border-radius: 50%;"></div>' : ''}
            </div>
        </div>
    `).join('');
}

function handleNotificationClick(type, id) {
    if (type === 'query') {
        showSection('queries');
        toggleNotifications();
    } else if (type === 'product') {
        showSection('products');
        toggleNotifications();
    }
}

function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
    return date.toLocaleDateString();
}

async function loadDashboardStats() {
    try {
        const { count: usersCount, error: usersError } = await supabase.from('users_profiles').select('*', { count: 'exact', head: true });
        if (usersError) console.error('Error loading users count:', usersError);
        document.getElementById('totalUsers').textContent = usersCount || 0;
        
        const { data: products, count: productCount, error: productsError } = await supabase.from('marketplace_products').select('*', { count: 'exact' });
        if (productsError) console.error('Error loading products:', productsError);
        document.getElementById('totalProducts').textContent = productCount || 0;
        
        if (products && products.length > 0) {
            const totalRevenue = products.reduce((sum, p) => {
                const price = parseFloat(p.price) || 0;
                const quantity = parseInt(p.quantity) || 1;
                return sum + (price * quantity * 0.1);
            }, 0);
            document.getElementById('totalRevenue').textContent = Math.round(totalRevenue).toLocaleString();
        }
        
        const { count: queriesCount, error: queriesError } = await supabase.from('expert_queries').select('*', { count: 'exact', head: true });
        if (queriesError) console.error('Error loading queries:', queriesError);
        document.getElementById('totalQueries').textContent = queriesCount || 0;
        
        loadRecentActivity();
    } catch (error) {
        console.error('Error loading stats:', error);
        showToast('Error loading dashboard statistics', 'error');
    }
}

async function loadRecentActivity() {
    try {
        const { data: recentQueries } = await supabase.from('expert_queries').select('*').order('created_at', { ascending: false }).limit(4);
        const activities = [];
        if (recentQueries && recentQueries.length > 0) {
            recentQueries.forEach(q => {
                activities.push({
                    icon: 'chat-left-text',
                    text: `Query from ${q.name || 'Farmer'}`,
                    time: getTimeAgo(q.created_at),
                    color: '#4facfe'
                });
            });
        }
        const html = activities.map(a => `
            <div style="display: flex; gap: 1rem; padding: 1rem; border-left: 3px solid ${a.color}; margin-bottom: 1rem; background: #f8f9fa; border-radius: 10px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                <i class="bi bi-${a.icon}" style="font-size: 1.5rem; color: ${a.color};"></i>
                <div style="flex: 1;">
                    <div>${a.text}</div>
                    <div style="font-size: 0.8rem; color: #666;">${a.time}</div>
                </div>
            </div>
        `).join('');
        document.getElementById('recentActivity').innerHTML = html || '<p class="text-muted">No recent activity</p>';
    } catch (error) {
        console.error('Error loading activity:', error);
    }
}

async function loadUsers() {
    const tbody = document.getElementById('usersTableBody');
    try {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading users...</p></td></tr>';
        const { data: profiles, error } = await supabase.from('users_profiles').select('*').order('created_at', { ascending: false });
        if (error) {
            console.error('Supabase error:', error);
            tbody.innerHTML = `<tr><td colspan="6"><div class="error-message"><strong>Error loading users:</strong> ${error.message}<br><small>Please check if the 'users_profiles' table exists in Supabase and RLS policies are configured correctly.</small></div></td></tr>`;
            return;
        }
        if (!profiles || profiles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i><p class="mt-2">No users found. The table is empty.</p><small class="text-muted">Users will appear here once they register.</small></td></tr>';
            return;
        }
        tbody.innerHTML = profiles.map(user => `
            <tr style="animation: fadeInUp 0.4s ease;">
                <td>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                            ${(user.name || user.email || 'U')[0].toUpperCase()}
                        </div>
                        <div><div style="font-weight: 600;">${user.name || 'User'}</div></div>
                    </div>
                </td>
                <td>${user.email || 'N/A'}</td>
                <td>${user.phone || 'N/A'}</td>
                <td><span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.5rem 1rem; border-radius: 20px;">${user.role || 'farmer'}</span></td>
                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn-action btn-view" title="View Details" onclick="viewUser('${user.id}')"><i class="bi bi-eye"></i></button>
                    <button class="btn-action btn-delete" onclick="deleteUser('${user.id}')" title="Delete User"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
        document.getElementById('totalUsers').textContent = profiles.length;
    } catch (error) {
        console.error('Error loading users:', error);
        tbody.innerHTML = `<tr><td colspan="6"><div class="error-message"><strong>Unexpected error:</strong> ${error.message}</div></td></tr>`;
    }
}

async function loadProducts() {
    const tbody = document.getElementById('productsTableBody');
    try {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading products...</p></td></tr>';
        const { data: products, error } = await supabase.from('marketplace_products').select('*').order('created_at', { ascending: false });
        if (error) {
            console.error('Supabase error:', error);
            tbody.innerHTML = `<tr><td colspan="6"><div class="error-message"><strong>Error loading products:</strong> ${error.message}</div></td></tr>`;
            return;
        }
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i><p class="mt-2">No products found</p></td></tr>';
            return;
        }
        const categoryIcons = { grains: '🌾', vegetables: '🥕', fruits: '🍎', dairy: '🥛' };
        tbody.innerHTML = products.map(p => `
            <tr style="animation: fadeInUp 0.4s ease;">
                <td>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            ${categoryIcons[p.category] || '📦'}
                        </div>
                        <div style="font-weight: 600;">${p.name || 'Unnamed Product'}</div>
                    </div>
                </td>
                <td><span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.5rem 1rem; border-radius: 20px;">${p.category || 'other'}</span></td>
                <td>${p.seller_name || p.name_seller || 'Unknown'}</td>
                <td style="font-weight: 700; color: #43e97b;">₹${p.price || 0}/${p.unit || 'kg'}</td>
                <td>${p.quantity || 'N/A'}</td>
                <td>
                    <button class="btn-action btn-view" title="View" onclick="viewProduct('${p.id}')"><i class="bi bi-eye"></i></button>
                    <button class="btn-action btn-delete" onclick="deleteProduct('${p.id}')" title="Delete"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading products:', error);
        tbody.innerHTML = `<tr><td colspan="6"><div class="error-message"><strong>Unexpected error:</strong> ${error.message}</div></td></tr>`;
    }
}

async function loadQueries() {
    const tbody = document.getElementById('queriesTableBody');
    try {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2">Loading queries...</p></td></tr>';
        const { data: queries, error } = await supabase.from('expert_queries').select('*').order('created_at', { ascending: false });
        if (error) {
            console.error('Supabase error:', error);
            tbody.innerHTML = `<tr><td colspan="6"><div class="error-message"><strong>Error loading queries:</strong> ${error.message}</div></td></tr>`;
            return;
        }
        if (!queries || queries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i><p class="mt-2">No queries found</p></td></tr>';
            return;
        }
        tbody.innerHTML = queries.map(q => `
            <tr style="animation: fadeInUp 0.4s ease;">
                <td>${new Date(q.created_at).toLocaleDateString()}</td>
                <td style="font-weight: 600;">${q.name || 'Anonymous'}</td>
                <td>${q.phone || 'N/A'}</td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${q.query || q.message || 'No message'}</td>
                <td><span class="badge" style="background: ${q.status === 'resolved' ? '#43e97b' : '#ffc107'}; color: white; padding: 0.5rem 1rem; border-radius: 20px;">${q.status || 'Pending'}</span></td>
                <td>
                    <button class="btn-action btn-view" onclick="viewQuery('${q.id}')" title="View Details"><i class="bi bi-eye"></i></button>
                    <button class="btn-action btn-edit" onclick="markResolved('${q.id}')" title="Mark Resolved"><i class="bi bi-check2"></i></button>
                </td>
            </tr>
        `).join('');
        document.getElementById('totalQueries').textContent = queries.length;
    } catch (error) {
        console.error('Error loading queries:', error);
        tbody.innerHTML = `<tr><td colspan="6"><div class="error-message"><strong>Unexpected error:</strong> ${error.message}</div></td></tr>`;
    }
}

async function viewQuery(queryId) {
    try {
        const { data: query, error } = await supabase.from('expert_queries').select('*').eq('id', queryId).single();
        if (error) throw error;
        const modal = new bootstrap.Modal(document.getElementById('queryDetailModal'));
        document.getElementById('queryDetailBody').innerHTML = `
            <div class="row g-3">
                <div class="col-md-6"><strong>Name:</strong> ${query.name || 'N/A'}</div>
                <div class="col-md-6"><strong>Phone:</strong> ${query.phone || 'N/A'}</div>
                <div class="col-md-6"><strong>Email:</strong> ${query.email || 'N/A'}</div>
                <div class="col-md-6"><strong>Date:</strong> ${new Date(query.created_at).toLocaleString()}</div>
                <div class="col-12"><strong>Query:</strong><div class="mt-2 p-3" style="background: #f8f9fa; border-radius: 10px;">${query.query || query.message || 'No message provided'}</div></div>
            </div>
        `;
        modal.show();
    } catch (error) {
        showToast('Error loading query details', 'error');
    }
}

async function markResolved(queryId) {
    try {
        const { error } = await supabase.from('expert_queries').update({ status: 'resolved' }).eq('id', queryId);
        if (error) throw error;
        showToast('Query marked as resolved', 'success');
        loadQueries();
    } catch (error) {
        showToast('Error updating query', 'error');
    }
}

function viewUser(userId) {
    showToast('User details view - Feature coming soon', 'info');
}

function viewProduct(productId) {
    showToast('Product details view - Feature coming soon', 'info');
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    try {
        const { error } = await supabase.from('users_profiles').delete().eq('id', userId);
        if (error) throw error;
        showToast('User deleted successfully', 'success');
        loadUsers();
        loadDashboardStats();
    } catch (error) {
        console.error('Delete error:', error);
        showToast('Error deleting user: ' + error.message, 'error');
    }
}

async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    try {
        const { error } = await supabase.from('marketplace_products').delete().eq('id', productId);
        if (error) throw error;
        showToast('Product deleted successfully', 'success');
        loadProducts();
        loadDashboardStats();
    } catch (error) {
        console.error('Delete error:', error);
        showToast('Error deleting product: ' + error.message, 'error');
    }
}

async function initCharts() {
    try {
        const userCtx = document.getElementById('userGrowthChart');
        if (userCtx && !userGrowthChart) {
            const { data: profiles } = await supabase.from('users_profiles').select('created_at').order('created_at');
            const monthlyData = {};
            if (profiles && profiles.length > 0) {
                profiles.forEach(p => {
                    const month = new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    monthlyData[month] = (monthlyData[month] || 0) + 1;
                });
            } else {
                monthlyData['No Data'] = 0;
            }
            userGrowthChart = new Chart(userCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'New Users',
                        data: Object.values(monthlyData),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        const catCtx = document.getElementById('categoryChart');
        if (catCtx && !categoryChart) {
            const { data: products } = await supabase.from('marketplace_products').select('category');
            const categoryCount = {};
            if (products && products.length > 0) {
                products.forEach(p => {
                    const cat = p.category || 'other';
                    categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                });
            } else {
                categoryCount['No Data'] = 1;
            }
            categoryChart = new Chart(catCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryCount),
                    datasets: [{
                        data: Object.values(categoryCount),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        const revCtx = document.getElementById('revenueChart');
        if (revCtx && !revenueChart) {
            const { data: products } = await supabase.from('marketplace_products').select('price, quantity, created_at');
            const monthlyRevenue = {};
            if (products && products.length > 0) {
                products.forEach(p => {
                    const month = new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    const revenue = (parseFloat(p.price) || 0) * (parseInt(p.quantity) || 1) * 0.1;
                    monthlyRevenue[month] = (monthlyRevenue[month] || 0) + revenue;
                });
            } else {
                monthlyRevenue['No Data'] = 0;
            }
            revenueChart = new Chart(revCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyRevenue),
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: Object.values(monthlyRevenue),
                        backgroundColor: 'rgba(67, 233, 123, 0.6)',
                        borderColor: 'rgba(67, 233, 123, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
}

function updateDateTime() {
    const elem = document.getElementById('currentDateTime');
    if (elem) {
        elem.textContent = new Date().toLocaleString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
}

function showToast(message, type) {
    const bgColors = {
        success: 'linear-gradient(135deg, #43e97b, #38f9d7)',
        error: 'linear-gradient(135deg, #eb3349, #f45c43)',
        warning: 'linear-gradient(135deg, #f093fb, #f5576c)',
        info: 'linear-gradient(135deg, #4facfe, #00f2fe)'
    };
    const toast = document.createElement('div');
    toast.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 1.25rem 1.75rem; border-radius: 15px; color: white; background: ${bgColors[type] || bgColors.info}; box-shadow: 0 8px 25px rgba(0,0,0,0.3); animation: slideInRight 0.4s ease; font-weight: 600;`;
    toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.4s ease';
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

async function logout() {
    try {
        await supabase.auth.signOut();
        window.location.href = 'signin.html';
    } catch (error) {
        showToast('Logout failed', 'error');
    }
}

document.getElementById('userSearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#usersTableBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
    });
});

document.getElementById('productSearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#productsTableBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
    });
});

document.getElementById('querySearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('#queriesTableBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
    });
});

document.getElementById('categoryFilter')?.addEventListener('change', function(e) {
    const category = e.target.value.toLowerCase();
    document.querySelectorAll('#productsTableBody tr').forEach(row => {
        if (!category) {
            row.style.display = '';
        } else {
            row.style.display = row.textContent.toLowerCase().includes(category) ? '' : 'none';
        }
    });
});

document.getElementById('queryStatusFilter')?.addEventListener('change', function(e) {
    const status = e.target.value.toLowerCase();
    document.querySelectorAll('#queriesTableBody tr').forEach(row => {
        if (!status) {
            row.style.display = '';
        } else {
            row.style.display = row.textContent.toLowerCase().includes(status) ? '' : 'none';
        }
    });
});

document.addEventListener('DOMContentLoaded', async function() {
    console.log('KrishiMitra Admin Dashboard - Initializing...');
    updateDateTime();
    setInterval(updateDateTime, 60000);
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const initial = (user.email || 'A')[0].toUpperCase();
            document.getElementById('userAvatar').textContent = initial;
            console.log('User authenticated:', user.email);
        } else {
            console.log('No authenticated user found');
        }
    } catch (error) {
        console.error('Auth check error:', error);
    }
    loadDashboardStats();
    loadNotifications();
    initCharts();
    console.log('KrishiMitra Admin Dashboard - Ready!');
});
</script>
</body>
</html>